
<table style="width: 90%">
	<colgroup>
		<col width="25%">
		<col width="25%">
		<col width="25%">
    <col width="25%">
	<colgroup>
			
	<tr>
    <td><h1>Patientenkartei</h1></td>
		<td style="text-align: center"><h1 style="text-decoration: underline"><%= link_to "zur Patientenübersicht", karteikarten_path() %></h1></td>
		<td style="text-align: center"><h1 style="text-decoration: underline"><%= link_to "zu den Abfragen", abfragen_karteikarten_path()%></h1></td>
		<td style="text-align: right"><h1 style="text-decoration: underline">abmelden</h1></td>
	</tr>
</table>



<%= form_for @karteikarte do |karteikarte_form| %>
   <div style="border: 1px solid black">
		<table>
			<tr>  
				<td>
					<table>
						<%= karteikarte_form.fields_for @person do |person_form| %>
							<tr>
								<td>Anrede</td>
                <td><%= person_form.select :anredewert_id, Lookup.anredewerte %></td>
							</tr>
							<tr>
								<td>Titel</td>
                <td><%= person_form.text_field :titel, :size => 30, :maxlength => 30 %></td>
							</tr>
							<tr>
								<td>Familienname</td>
                <td><%= person_form.text_field :familienname, :size => 30, :maxlength => 40 %></td>
							</tr>
							<tr>
								<td>Vorname</td>
                <td><%= person_form.text_field :vorname, :size => 30, :maxlength => 40 %></td>
							</tr>
							<tr>
								<td>Notiz</td>
                <td><%= person_form.text_area :notiz, :size => "28x2", :maxlength => 200, :style => "resize: none" %></td>
							</tr>
							<tr>
								<td>Kunde</td>
                <td><%= person_form.check_box :kunden_kz %></td>
							</tr>
						
							<%= person_form.fields_for :postadressen do |postadresse_form| %>
								<tr>
									<td>PLZ</td>
                  <td><%= postadresse_form.text_field :plz, :size => 30, :maxlength => 10 %></td>
								</tr>
								<tr>
									<td>Ort</td>
                  <td><%= postadresse_form.text_field :ort, :size => 30, :maxlength => 40 %></td>
								</tr>
								<tr>
									<td>Straße</td>
                  <td><%= postadresse_form.text_field :strasse, :size => 30, :maxlength => 40 %></td>
								</tr>
							<% end %><!-- fields postadressen -->

							<%= person_form.fields_for :kontakte do |kontakte_form| %>
								<tr>
									<td>Telefonnr.</td>
                  <td><%= kontakte_form.text_field :kontakt, :size => 30, :maxlength => 50 %></td>
								</tr>
							<% end %> <!-- fields kontakte -->
						<% end %> <!-- fields person -->
					</table>
				</td>
				<td>

		<%= karteikarte_form.fields_for @tier do |tier_form| %>
					<table>
							<tr>
								<td>Tiername</td>
                <td><%= tier_form.text_field :tiername, :size => 30, :maxlength => 30 %></td>
							</tr>
							<tr>
								<td>Tierart</td>
                <td><%= tier_form.text_field :tierart, :size => 30, :maxlength => 30 %></td>
							</tr>
							<tr>
								<td>Rasse</td>
                <td><%= tier_form.text_field :rasse, :size => 30, :maxlength => 30 %></td>
							</tr>
							<tr>
								<td>Farbe</td>
                <td><%= tier_form.text_field :farbe, :size => 30, :maxlength => 50 %></td>
							</tr>
							<tr>
								<td>Geburtsdatum</td>
                <td><%= tier_form.text_field :geburtsdatum_str, :size => 30, :maxlength => 10, :class => "datum" %></td>
							</tr>
							<tr>
								<td>Geschlecht</td>
                <td><%= tier_form.select :geschlechtswert_id, Lookup.geschlechtswerte %></td>
							</tr>
							<tr>
								<td>Chipnr.</td>
                <td><%= tier_form.text_field :chipnr, :size => 30, :maxlength => 30 %></td>
							</tr>
							<tr>
								<td>EU-Passnr.</td>
                <td><%= tier_form.text_field :eu_passnr, :size => 30, :maxlength => 30 %></td>
							</tr>
							<tr>
								<td>Patient</td>
                <td><%= tier_form.check_box :patienten_kz %></td>
							</tr>
							<tr>
								<td>Viren</td>
                <td><%= tier_form.text_field :viren, :size => 30, :maxlength => 50 %></td>
							</tr>
							<tr>
								<td>Merkmal</td>
                <td><%= tier_form.text_field :merkmal, :size => 30, :maxlength => 50 %></td>
							</tr>
					</table>
    <% end %> <!-- fields tier -->
	
				</td>
			</tr>
		</table>
   </div>
	
	<%= link_to "neue Behandlung", '#', :onclick => "clearEditfields()" %>
	
	<div id='behandlung_form'>
	  <%= render :partial => "behandlung_form", :locals => { :edit_behandlung => @edit_behandlung }, :action => 'edit_behandlung_karteikarte'  %>
	</div>

	
	<div id='behandlungen_index'>
	  <%= render :partial => "behandlungen_index", :locals => { :behandlungen => @tier.behandlungen.order( 'behandlungsdatum desc' ) }, :action => 'karteikarten'  %>
	</div>	
	
	<p>
	<table>
		<tr>
			<td>
				<%= karteikarte_form.submit "sichern",	:class => "text_button" %>
			</td>
			<td>
				<%= link_to 'zurück', karteikarten_path, :class => "text_button" %>
			</td>
		</tr>
	</table>
</p>
  
<% end %>





<p style="display: none">
	<%= select_tag "laborwerte", options_from_collection_for_select(Lookup.laborwerte, "id", "wert", selected_value="id"), :id => 'lab', :multiple => true %>
</p>


<script>
	var labor_text_feld;
	
	function get_lab_list_text(){
	    var buf = "";
		$( '#lab option:selected').each(function () {
			buf += $(this).text() + "\n ";
		});
		
		return buf;
	};


	$.datepicker.setDefaults($.datepicker.regional['']);  
  	
	$(document).ready(function() {
		$(".impf_select").attr("data-placeholder", "bitte auswählen");
		$(".impf_select").chosen();
		
    $( ".karteikarte tr" ).click( function() {
			  // alert( 'hallo ' + $(this).attr( 'data-id' ));
				  $( '.karteikarte tr' ).removeClass( 'highlight' );
					$(this).addClass('highlight');
					
				// var inputobj = $('input#behandlung_id');
				var behandlung_id_alt = $('input#behandlung_id').attr("value");
				// if(inputobj.attr("value") != ""){
				if(behandlung_id_alt != ""){
					$.post( '/karteikarten/' + behandlung_id_alt + '/update_behandlung',
										{ behandlungsdatum_str: $('#edit_behandlung_behandlungsdatum_str').val(),
										  diagnose: 						$('#edit_behandlung_diagnose').text(),
											laborwerte1:					$('#edit_behandlung_laborwerte1').text(),
											laborwerte2:					$('#edit_behandlung_laborwert2').text(),
											arzneien:							$('#edit_behandlung_arzneien').text(),
											arzneimittel:					$('#edit_behandlung_arzneimittel').text(),
											impfungswert_ids:			$('#edit_behandlung_impfungswert_ids').val(),
											gewicht_kg:						$('#edit_behandlung_gewicht_kg').val()
									} );

				// var behandlung_alt = $("tr[data-id=" + behandlung_id_alt + "]");
				// alert( behandlung_alt.html() );
				//behandlung_alt
				// $("tr[data-id=" + behandlung_id_alt + "]").get( '/karteikarten/'+ behandlung_id_alt + '/edit_behandlung', null, 'script');
				}
				
				$.get( '/karteikarten/'+ $(this).attr( 'data-id' ) + '/edit_behandlung', null, 'script');

			} );
    
      // $( ".behandlung1 textarea" ).removeAttr( "cols" ).removeAttr( "rows");
	
		var $dialog_labor = $('<div></div>');
		
		$dialog_labor.html( $("#lab") );
		
		$dialog_labor.dialog({
				autoOpen: false,
				title: 'Laborwerte',
				modal: true,
				buttons: [ { text: "OK", click: function() { 
							 labor_text_feld.value = labor_text_feld.value + get_lab_list_text() + '**';
			                 $('#lab option').attr('selected', false );
							 labor_text_feld.focus(); 
							 $(this).dialog("close"); } },
						   { text: "Abbruch", click: function() { 
							  labor_text_feld.focus();
							  $(this).dialog("close"); } } ] 
			});

	
			
		$('.labor').click(  function() {
			labor_text_feld = this;
			$dialog_labor.dialog('open');
			// prevent the default action, e.g., following a link
			return false;
		});
	
	
		$(function() {
			$( ".datum" ).datepicker({ changeYear: true, dateFormat: 'dd.mm.yy' });
			$(".datum").datepicker($.datepicker.regional['de']);
		});	
		
	});

	function clearEditfields(){
		// var domobj1 = $('div#behandlung_form');
		var ausgabe1;
		var ausgabe2;
		var suche; 		
		var inputobj = $('input#behandlung_id');
		if(inputobj.attr("value") != ""){
			// ausgabe = inputobj.attr("value");
			ausgabe1 = $('#edit_behandlung_behandlungsdatum_str').val() + 
								$('#edit_behandlung_laborwerte1').text() + 
								$('#edit_behandlung_laborwerte2').text() +
								$('#edit_behandlung_arzneien').text() +
								$('#edit_behandlung_arzneimittel').text() +
								$('#edit_behandlung_impfungswert_ids').html() +
								$('#edit_behandlung_gewicht_kg').val();

			$('#edit_behandlung_behandlungsdatum_str').val("01.01.2012"); 
			$('#edit_behandlung_laborwerte1').text(""); 
			$('#edit_behandlung_laborwerte2').text("");
			$('#edit_behandlung_arzneien').text("");
			$('#edit_behandlung_arzneimittel').text("");
			suche = $('#edit_behandlung_impfungswert_ids');
			$('option', suche).removeAttr("selected");
			$('#edit_behandlung_gewicht_kg').val("");

			ausgabe2 = $('#edit_behandlung_behandlungsdatum_str').val() + 
								$('#edit_behandlung_laborwerte1').text() + 
								$('#edit_behandlung_laborwerte2').text() +
								$('#edit_behandlung_arzneien').text() +
								$('#edit_behandlung_arzneimittel').text() +
								$('#edit_behandlung_impfungswert_ids').html() +
								$('#edit_behandlung_gewicht_kg').val();

		}
		else{
			ausgabe1 = -1;
			ausgabe2 = -1;
		}
		
		//.attr("value");
		// var element = $("div#behandlung_form");
		// element.show();
		// $.get( '/karteikarten/'+ $(this).attr( 'data-id' ) + '/edit_behandlung', null, 'script');					 
		alert( ausgabe1 + "***" + ausgabe2 );
		
		$(".impf_select").chosen().trigger("liszt:updated");
		
		// behandlung_id
		// + element
	};	
</script>
